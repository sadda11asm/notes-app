{"version":3,"sources":["../../server/middlewares/isAuth.js"],"names":["require","config","redis","jwt","checkToken","req","res","next","token","headers","startsWith","slice","length","verify","process","env","JWT_SECRET","err","decoded","json","success","message","checkCache","val","console","log","status","error","callback","port_redis","PORT","redis_client","createClient","get","module","exports"],"mappings":"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","sourcesContent":["require('dotenv').config();\nconst redis = require('redis')\nlet jwt = require('jsonwebtoken');\n\nfunction checkToken (req, res, next) {\n  // console.log(next)\n  let token = req.headers['x-access-token'] || req.headers['authorization']; // Express headers are auto converted to lowercase\n  if (token.startsWith('Bearer ')) {\n    // Remove Bearer from string\n    token = token.slice(7, token.length);\n  }\n\n  if (token) {\n    jwt.verify(token, process.env.JWT_SECRET, function (err, decoded) {\n      if (err) {\n        return res.json({\n          success: false,\n          message: 'Token is not valid'\n        });\n      } else {\n        try {\n          checkCache(token, (err, val) => {\n            console.log()\n            if (err) {\n              return res.json({\n                status: 500,\n                message: 'Server error!'\n              });\n            } else if (val != null) {\n              return res.json({\n                status: 400,\n                message: 'Token is outdated!'\n              });\n            }\n            // console.log(\"Middleware!\")\n            // console.log(decoded)\n            req.decoded = decoded;\n            req.token = token\n            return next();\n          })\n        } catch(error) {\n          console.log(error)\n          return res.json({\n            success: false,\n            message: 'Server error'\n          });\n        }\n\n      }\n    });\n  } else {\n    return res.json({\n      success: false,\n      message: 'Auth token is not supplied'\n    });\n  }\n};\n\nfunction checkCache(token, callback) {\n  // check if token in redis cache\n  try {\n    const port_redis = process.env.PORT || 6379;\n    const redis_client = redis.createClient(port_redis);\n    redis_client.get(token, (err, val) => {\n      console.log(val)\n      callback(err, val)\n    })\n  } catch (error) {\n    callback(true)\n  }\n}\n\nmodule.exports = {\n  checkToken: checkToken\n}"],"file":"isAuth.js"}